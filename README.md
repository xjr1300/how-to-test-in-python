# テストの考え方と実装方法 in Python

[単体テストの考え方／使い方](https://book.mynavi.jp/ec/products/detail/id=134252)

![書籍表紙](https://book.mynavi.jp/files/topics/134252_ext_06_0.jpg?v=1670578534)

本文書では、**古典学派 (デトロイト学派) の解釈を採用**しています。

- [テストの考え方と実装方法 in Python](#テストの考え方と実装方法-in-python)
  - [テストの種類](#テストの種類)
    - [単体テスト (Unit Test) の概要](#単体テスト-unit-test-の概要)
    - [統合テスト (Integration Test) の概要](#統合テスト-integration-test-の概要)
    - [E2E (End to End Test) の概要](#e2e-end-to-end-test-の概要)
  - [テストを実装する理由](#テストを実装する理由)
  - [プロセス外依存](#プロセス外依存)
    - [管理下にある依存 (managed dependency)](#管理下にある依存-managed-dependency)
    - [管理下にない依存 (unmanaged dependency)](#管理下にない依存-unmanaged-dependency)

## テストの種類

- 単体テスト (Unit Test)
- 統合テスト (Integration Test)
- E2Eテスト (End to End Test)

### 単体テスト (Unit Test) の概要

- **1単位の振る舞い (a unit of behavior)** を検証すること
- 実行時間が短いこと
- 他のテストケースから隔離された状態で実行できること

単体テストでは、関数やクラスのメソッドなど、**1つの振る舞い**を検証します。

また、実行時間を短くすることで、**繰り返し単体テストを実行**できるように開発者の負担を軽減します。
実行時間が長くなると、開発者がテストを実行する回数が減り、バグを見つけるまでの時間が長くなります。
バグが見つかるまでの時間が長くなると、それまでにコードベースは大きくなるため、バグの特定と修正に時間がかかるようになります。

さらに、それぞれの単体テストが他の単体テストと独立することで、他の単体テストからの影響を受けず、個別に実行できるようになります。
これに、単体テストを**個別に実行**したり、同時に**複数の単体テストを並行／並列で実行**することができます。

### 統合テスト (Integration Test) の概要

`統合テスト`は、システム全体が意図したように機能することを検証するテストです。
システムの`ユースケース`ごとに、統合テストを実装して、それぞれまたは連続して実行します。

### E2E (End to End Test) の概要

`E2Eテスト`は、統合テストの上位に位置するテストです。
統合テストでは、システムが依存するメール送信サービスなどの外部サービスをテストダブルに置き換えますが、`E2Eテスト`では、ほぼすべての依存を実際のサービスを使用してテストします。

本文書では、`E2Eテスト`は説明の対象外とします。

## テストを実装する理由

テストを実装する理由は、システムが**将来も持続的に成長できるようにするため**です。
テストが実装されているシステムのことを`テスト対象システム (SUT: System Under Test)`と呼びます。

ほとんどのシステムは、リリース後に何度も仕様変更や改修が行われ、その中で`リファクタリング`されます。
テストが実装されているシステムの仕様変更や改修は、単体／統合テストを実行することで、変更がシステム全体に影響を与えないことを確認できます。
変更によりシステムに不具合が発生することを`退行 (regression)`と呼びますが、SUTは、退行を防ぐことができ、仕様変更や改修に対する開発者の負担を軽減します。

逆に、SUTでないシステムの変更は、変更がシステムに影響を与えたかを確認する工数が多くなり、開発者の負担が大きくなります。
この負担は、開発者のモチベーションを下げ、システムを変更しない理由となり、システムの成長を妨げるようになります。

システムのコードベースは、リリース後に成長しはじめ、劣化する傾向があるため、エントロピー（無秩序の量）が増大するため、リファクタリングが必要になります。
SUTは、退行を生み出す可能性が低くなり、リファクタリングに対する開発者の心理的不安をなくすことができます。

逆に、一時的に作成するプログラムなど、成長することがないシステムに対しては、簡易的なテストの実装で済ましたり、テストの実装を省くことができると考えられます。

## プロセス外依存

システムは、データベースやメール配信サービスなど、システムが動作するプロセス以外で動作する依存があります。
この`プロセス外依存`は、次の2つに区分されます。

- 管理下にある依存 (managed dependency)
- 管理下にない依存 (unmanaged dependency)

### 管理下にある依存 (managed dependency)

`管理下にある依存`は、SUTしかアクセスしないデータベースなど、SUTが自由に操作でき、その振る舞いを確認できる依存を示します。

単体テストでは、管理下にある依存をテストダブルで置き換え、テストの実行時間を短くします。
一方、統合テストでは、管理下にある依存を実際に利用したテストを実装します。

### 管理下にない依存 (unmanaged dependency)

`管理下にない依存`は、外部サービスなど、費用や過度に負荷を与えることができないなどの理由でSUTが自由に操作できない依存を示します。
管理下にない依存は、単体テスト及び統合テストでテストダブルに置き換えます。
